name: Deploy to Elastic Beanstalk

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies (root)
        run: npm ci

      - name: Build (client + server)
        run: npm run build

      - name: Prepare deploy folder (place server bundle at dist/index.js)
        run: |
          set -e
          rm -rf deploy || true
          mkdir deploy

          # Create a minimal runtime package.json (with type: module)
          node -e "
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('package.json','utf8'));
          const clean = {
            name: pkg.name || 'pixelvault-app',
            version: pkg.version || '1.0.0',
            private: (typeof pkg.private !== 'undefined') ? pkg.private : true,
            type: 'module',
            engines: pkg.engines || { node: '18.x' },
            dependencies: pkg.dependencies || {},
            scripts: { start: (pkg.scripts && pkg.scripts.start) ? pkg.scripts.start : 'node dist/index.js' }
          };
          fs.writeFileSync('deploy/package.json', JSON.stringify(clean, null, 2));
          console.log('Wrote deploy/package.json with keys:', Object.keys(clean));
          "

          # Copy Procfile if present
          cp Procfile deploy/ 2>/dev/null || true

          # Ensure server bundle is placed at deploy/dist/index.js
          if [ -f dist/index.js ]; then
            mkdir -p deploy/dist
            cp dist/index.js deploy/dist/index.js
            cp -r dist/*.map deploy/dist/ 2>/dev/null || true
          elif [ -f server/dist/index.js ]; then
            mkdir -p deploy/dist
            cp server/dist/index.js deploy/dist/index.js
            cp -r server/dist/* deploy/dist/ 2>/dev/null || true
          elif [ -f server/index-prod.js ]; then
            mkdir -p deploy/dist
            cp server/index-prod.js deploy/dist/index.js
          elif [ -f server/index-prod.ts ]; then
            echo 'ERROR: TypeScript source detected but server was not built. Ensure build script outputs server bundle to dist/index.js' >&2
            ls -la
            exit 1
          else
            echo "ERROR: no server bundle found at dist/index.js or server/dist/index.js" >&2
            ls -la
            exit 1
          fi

          # Copy client build: prefer client/dist, fallback to root dist (but do not overwrite server file)
          if [ -d client/dist ]; then
            mkdir -p deploy/client
            cp -r client/dist/* deploy/client/
          elif [ -d dist ] && [ -f dist/index.html ]; then
            mkdir -p deploy/client
            # Copy everything except the server bundle we already copied
            rsync -av --exclude 'index.js' dist/ deploy/client/
          fi

          # Copy public / views if present
          if [ -d public ]; then cp -r public deploy/public || true; fi
          if [ -d views ]; then cp -r views deploy/views || true; fi

          # Create a unique zip
          cd deploy
          zip -r ../pixelvault-${{ github.sha }}-${{ github.run_id }}.zip . -x "*.git*" "node_modules/*"
          cd ..

      - name: Show bundle size
        run: ls -lh pixelvault-${{ github.sha }}-${{ github.run_id }}.zip

      - name: List deploy bundle contents (debug)
        run: unzip -l pixelvault-${{ github.sha }}-${{ github.run_id }}.zip | sed -n '1,200p'

      - name: Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: ${{ secrets.EB_APPLICATION_NAME }}
          environment_name: ${{ secrets.EB_ENVIRONMENT_NAME }}
          region: ${{ secrets.AWS_REGION }}
          version_label: pixelvault-${{ github.sha }}-${{ github.run_id }}
          deployment_package: pixelvault-${{ github.sha }}-${{ github.run_id }}.zip
          use_existing_version_if_available: true
