name: Deploy to AWS Elastic Beanstalk

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies (root) (ci)
        run: npm install

      - name: Build (client + server)
        run: npm run build

      - name: Prepare deploy folder
        run: |
          rm -rf deploy || true
          mkdir deploy

          # Copy package metadata so EB can install runtime deps (if needed)
          cp package.json deploy/
          if [ -f package-lock.json ]; then cp package-lock.json deploy/; fi

          # Copy Procfile and any .ebextensions (if present)
          cp -r Procfile .ebextensions deploy/ 2>/dev/null || true

          # Copy compiled server bundle into deploy/
          # adjust if your server dist path differs
          if [ -d dist ]; then
            cp -r dist deploy/
          elif [ -d server/dist ]; then
            cp -r server/dist deploy/dist
          fi

          # Copy client build into deploy/public if you want EB to serve static files
          # If your client build is at client/dist, change the path below
          if [ -d client/dist ]; then
            mkdir -p deploy/public
            cp -r client/dist/* deploy/public/
          elif [ -d dist/public ]; then
            mkdir -p deploy/public
            cp -r dist/public/* deploy/public/
          fi

          # Exclude node_modules and git artifacts from zip
          cd deploy
          zip -r ../pixelvault-${{ github.sha }}.zip . -x "*.git*" "node_modules/*"
          cd ..

      - name: Show bundle size
        run: ls -lh pixelvault-${{ github.sha }}.zip || true

      - name: Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: ${{ secrets.EB_APPLICATION_NAME }}
          environment_name: ${{ secrets.EB_ENVIRONMENT_NAME }}
          region: ${{ secrets.AWS_REGION }}
          version_label: pixelvault-${{ github.sha }}
          deployment_package: pixelvault-${{ github.sha }}.zip
          use_existing_version_if_available: true
